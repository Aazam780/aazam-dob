<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aazam DOB</title>
  <style>
    :root{--bg:#0f1225;--card:#151a33;--accent:#7c5cff;--text:#e8e9ff;--muted:#a4a8c9}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:radial-gradient(1200px 600px at 20% 0%,#1b2042 0,#0f1225 50%,#0b0e1d 100%);color:var(--text)}
    .wrap{max-width:560px;margin:16px auto 64px;padding:16px}
    .card{background:linear-gradient(180deg,#171c3a 0,#11162f 100%);border:1px solid #23284b;border-radius:16px;padding:18px;box-shadow:0 8px 30px rgba(0,0,0,.35)}
    h1{font-size:22px;margin:8px 0 12px}
    label{display:block;color:var(--muted);font-size:14px;margin-bottom:6px}
    input[type="date"],input[type="text"],textarea{width:100%;background:#0f1430;color:var(--text);border:1px solid #2a2f59;border-radius:10px;padding:12px;font-size:15px;outline:none}
    textarea{min-height:96px;resize:vertical}
    button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer;box-shadow:0 6px 18px rgba(124,92,255,.35)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:10px;align-items:center}
    .row>*{flex:1}
    .spacer{height:14px}
    .msg{background:#0f1430;border:1px solid #2a2f59;border-radius:12px;padding:12px;white-space:pre-wrap;line-height:1.5}
    .muted{color:var(--muted);font-size:13px}
    .chip{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700}
    .chip.none{background:#253158;color:#b9c1ff}.chip.new{background:#2a315d;color:#9ab3ff}
    .chip.seen{background:#214d36;color:#b7ffd5}.chip.replied{background:#2a3a1f;color:#d8ffb3}
    .footer{margin-top:20px;color:#8b8fb5;font-size:12px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Apna DOB select karo</h1>
      <label for="dob">Full date (DD‑MM‑YYYY)</label>
      <div class="row">
        <input id="dob" type="date" />
        <button id="showBtn">Dikhaye</button>
      </div>
      <div class="spacer"></div>
      <div id="result" style="display:none">
        <div class="row" style="justify-content:space-between">
          <div class="muted" id="dobText"></div>
          <div><span id="statusChip" class="chip none">Status: -</span></div>
        </div>
        <div class="spacer"></div>
        <div class="msg" id="messageBox"></div>
        <div class="spacer"></div>
        <div class="muted" id="replyText" style="display:none"></div>
      </div>
    </div>

    <div class="spacer"></div>

    <div class="card" style="background:#0f1430;border:1px dashed #2a2f59;">
      <h1 style="font-size:18px;margin:0 0 8px">Aazam ke liye message chhode</h1>
      <div class="spacer"></div>
      <label for="name">Naam (optional)</label>
      <input id="name" type="text" placeholder="Aapka naam (optional)" />
      <div class="spacer"></div>
      <label for="umsg">Aapka message</label>
      <textarea id="umsg" placeholder="Yahan likho..."></textarea>
      <div class="spacer"></div>
      <button id="sendBtn" disabled>Message bhejo</button>
      <div class="spacer"></div>
      <div class="muted">Tip: DOB fir se daal ke status dekh sakte ho (Seen / Replied).</div>
    </div>

    <div class="footer">Made for friends ✨</div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // APNI VALUES YAHAN DAALEN
    const SUPABASE_URL = 'https://qvgoplbkmxgyevhduaot.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2Z29wbGJrbXhneWV2aGR1YW90Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxOTA5ODMsImV4cCI6MjA3Nzc2Njk4M30.MRSkvKeh5pyn3ZrdCehI_SV5cAb1Z--sewnvhF4bFns';

    const sb = createClient(SUPABASE_URL, SUPABASE_ANON);

    const $ = (id) => document.getElementById(id);
    const showBtn = $('showBtn');
    const sendBtn = $('sendBtn');
    const dobInput = $('dob');

    let currentDobIso = null;

    function ensureClientId(){
      let id = localStorage.getItem('aazam_client_id');
      if(!id){
        id = (crypto.randomUUID ? crypto.randomUUID() :
              Date.now().toString(36)+Math.random().toString(36).slice(2));
        localStorage.setItem('aazam_client_id', id);
      }
      return id;
    }
    const CLIENT_ID = ensureClientId();

    function toNice(iso){
      const [y,m,d] = iso.split('-');
      const MMM = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][+m-1];
      return `${d} ${MMM} ${y}`;
    }

    function setStatusChip(st){
      const chip = $('statusChip');
      chip.className = 'chip ' + (st || 'none');
      const label = st==='new'?'Pending':st==='seen'?'Seen':st==='replied'?'Replied':'-';
      chip.textContent = 'Status: ' + label;
    }

    async function fetchFallback(){
      const { data, error } = await sb.from('settings').select('value').eq('key','fallback_message').single();
      if (error) return 'Sorry, Aazam ne aapke liye abhi kuch set nahi kiya hai.';
      return data?.value || 'Sorry, Aazam ne aapke liye abhi kuch set nahi kiya hai.';
    }

    async function showDOB(){
      const dob = dobInput.value;
      if(!dob){ alert('DOB select karo'); return; }
      currentDobIso = dob;
      showBtn.disabled = true; sendBtn.disabled = true;

      try{
        const fallback = await fetchFallback();

        const { data: rows } = await sb
          .from('dob_messages').select('message').eq('dob_date', dob).limit(1);
        const message = rows && rows.length ? rows[0].message : fallback;

        const { data: stRows } = await sb
          .from('status_lookup').select('status, reply_text')
          .eq('client_id', CLIENT_ID).eq('dob_date', dob).limit(1);
        const status = stRows && stRows.length ? stRows[0].status : 'none';
        const replyText = stRows && stRows.length ? (stRows[0].reply_text || '') : '';

        await sb.from('views_log').insert([{ dob_date: dob, client_id: CLIENT_ID, user_agent: navigator.userAgent }]);

        $('result').style.display = 'block';
        $('dobText').textContent = toNice(dob);
        $('messageBox').textContent = message || '';
        setStatusChip(status);
        if (replyText){
          $('replyText').style.display = 'block';
          $('replyText').textContent = 'Aazam ka reply: ' + replyText;
        } else {
          $('replyText').style.display = 'none';
          $('replyText').textContent = '';
        }
        sendBtn.disabled = false;
      }catch(e){
        alert('Error: ' + e.message);
      }finally{
        showBtn.disabled = false;
      }
    }

    async function sendMsg(){
      if(!currentDobIso){ alert('Pehle DOB select karo'); return; }
      const text = $('umsg').value.trim();
      if(!text){ alert('Message likho'); return; }
      const name = $('name').value.trim();
      sendBtn.disabled = true;
      try{
        const { error } = await sb.from('user_messages').insert([{
          dob_date: currentDobIso,
          client_id: CLIENT_ID,
          name: name || null,
          message: text
        }]);
        if (error) throw error;
        $('umsg').value = '';
        setStatusChip('new');
        alert('Message bhej diya! DOB dubara dal ke status check kar sakte ho.');
      }catch(e){
        alert('Send error: ' + e.message);
      }finally{
        sendBtn.disabled = false;
      }
    }

    showBtn.addEventListener('click', showDOB);
    sendBtn.addEventListener('click', sendMsg);

    (function initDate(){
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth()+1).padStart(2,'0');
      const d = String(today.getDate()).padStart(2,'0');
      dobInput.setAttribute('max', `${y}-${m}-${d}`);
      dobInput.setAttribute('min', `1900-01-01`);
    })();
  </script>
</body>
</html>
